name: Auto-Tag Version Changes

on:
  push:
    branches: [main]
    paths: ['pyproject.toml']
  workflow_dispatch:
    inputs:
      force_tag:
        description: "Force tag creation even if version hasn't changed"
        required: false
        default: false
        type: boolean
      dry_run:
        description: "Perform a dry run (no actual tags created)"
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  actions: read

jobs:
  detect-version-change:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version_info.outputs.current_version }}
      should_tag: ${{ steps.tag_decision.outputs.should_tag }}
      tag_exists: ${{ steps.version_info.outputs.tag_exists }}
      valid: ${{ steps.version_info.outputs.valid_semver }}
      latest_tag: ${{ steps.version_info.outputs.latest_tag }}
      latest_version: ${{ steps.version_info.outputs.latest_version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect version information
        id: version_info
        run: python .github/scripts/version_info.py --output "$GITHUB_OUTPUT"

      - name: Determine tagging decision
        id: tag_decision
        run: |
          FORCE="${{ github.event.inputs.force_tag || 'false' }}"
          SHOULD="${{ steps.version_info.outputs.should_tag }}"

          if [[ "$FORCE" == "true" ]]; then
            echo "ğŸ”§ Force tag mode enabled"
            echo "should_tag=true" >> $GITHUB_OUTPUT
          else
            echo "should_tag=$SHOULD" >> $GITHUB_OUTPUT
          fi

  create-and-push-tag:
    needs: detect-version-change
    if: |
      needs.detect-version-change.outputs.should_tag == 'true' &&
      needs.detect-version-change.outputs.tag_exists == 'false' &&
      needs.detect-version-change.outputs.valid == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create and push tag
        run: |
          VERSION="${{ needs.detect-version-change.outputs.version }}"
          TAG_NAME="v$VERSION"
          DRY_RUN="${{ github.event.inputs.dry_run || 'false' }}"

          echo "ğŸ·ï¸ Creating tag: $TAG_NAME"
          echo "ğŸ“ Version: $VERSION"
          echo "ğŸ”§ Dry run: $DRY_RUN"

          if [[ "$DRY_RUN" == "true" ]]; then
            echo "ğŸ§ª DRY RUN: Would create tag $TAG_NAME"
            echo "ğŸ§ª DRY RUN: Would push tag to trigger publish.yml workflow"
          else
            git tag -a "$TAG_NAME" -m "Release $TAG_NAME"
            git push origin "$TAG_NAME"

            echo "âœ… Tag $TAG_NAME created and pushed successfully"
            echo "ğŸš€ This will trigger the publish.yml workflow"
          fi

  skip-tagging:
    needs: detect-version-change
    if: |
      needs.detect-version-change.outputs.should_tag == 'false' ||
      needs.detect-version-change.outputs.tag_exists == 'true' ||
      needs.detect-version-change.outputs.valid == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: Report skip reason
        run: |
          SHOULD_TAG="${{ needs.detect-version-change.outputs.should_tag }}"
          TAG_EXISTS="${{ needs.detect-version-change.outputs.tag_exists }}"
          VALID="${{ needs.detect-version-change.outputs.valid }}"
          VERSION="${{ needs.detect-version-change.outputs.version }}"
          LATEST_TAG="${{ needs.detect-version-change.outputs.latest_tag }}"
          LATEST_VERSION="${{ needs.detect-version-change.outputs.latest_version }}"

          echo "ğŸ“‹ Version tagging analysis complete"
          echo "ğŸ“ Version: $VERSION"
          echo "ğŸ·ï¸ Latest tag: ${LATEST_TAG:-none}"
          echo "ğŸ”¢ Latest version: $LATEST_VERSION"
          echo "ğŸ·ï¸ Should tag: $SHOULD_TAG"
          echo "ğŸ” Tag exists: $TAG_EXISTS"
          echo "âœ… Valid version: $VALID"

          if [[ "$VALID" == "false" ]]; then
            echo "âŒ Skipping: Version does not follow semantic versioning"
          elif [[ "$TAG_EXISTS" == "true" ]]; then
            echo "âŒ Skipping: Tag already exists"
          elif [[ "$SHOULD_TAG" == "false" ]]; then
            echo "â„¹ï¸ Skipping: Version unchanged or not newer"
          fi

          echo "ğŸ’¡ To force tag creation, use workflow_dispatch with force_tag=true"
