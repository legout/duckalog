name: Auto-Tag Version Changes

on:
  push:
    branches: [main]
    paths: ['pyproject.toml']
  workflow_dispatch:
    inputs:
      force_tag:
        description: "Force tag creation even if version hasn't changed"
        required: false
        default: false
        type: boolean
      dry_run:
        description: "Perform a dry run (no actual tags created)"
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  actions: read

jobs:
  detect-version-change:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.extract_version.outputs.version }}
      should_tag: ${{ steps.compare_versions.outputs.should_tag }}
      tag_exists: ${{ steps.check_tag_exists.outputs.tag_exists }}
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for proper tag comparison

      - name: Extract version from pyproject.toml
        id: extract_version
        run: |
          echo "ğŸ” Extracting version from pyproject.toml..."
          
          # Try to extract version using Python
          VERSION=$(python -c "
          import sys
          try:
              import tomllib
          except ImportError:
              import tomli as tomllib
          
          try:
              with open('pyproject.toml', 'rb') as f:
                  data = tomllib.load(f)
              version = data['project']['version']
              print(f'âœ… Extracted version: {version}')
              print(f'::set-output name=version::{version}')
          except Exception as e:
              print(f'âŒ Error extracting version: {e}', file=sys.stderr)
              sys.exit(1)
          " || {
            echo "âŒ Failed to extract version from pyproject.toml"
            exit 1
          }
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Validate semantic versioning
        id: validate_version
        run: |
          echo "ğŸ” Validating semantic versioning..."
          VERSION="${{ steps.extract_version.outputs.version }}"
          
          # Simple semantic versioning validation
          if [[ $VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âœ… Version $VERSION follows semantic versioning"
            echo "valid=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Version $VERSION does not follow semantic versioning (expected format: X.Y.Z)"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Get existing tags
        id: get_tags
        run: |
          echo "ğŸ“‹ Fetching existing tags..."
          git fetch --tags
          
          # Get latest version tag
          LATEST_TAG=$(git describe --tags --abbrev=0 --match='v[0-9]*' 2>/dev/null || echo "")
          if [[ -n "$LATEST_TAG" ]]; then
            LATEST_VERSION=${LATEST_TAG#v}
            echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
            echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
            echo "ğŸ“‹ Latest version tag: $LATEST_TAG"
          else
            echo "latest_tag=" >> $GITHUB_OUTPUT
            echo "latest_version=0.0.0" >> $GITHUB_OUTPUT
            echo "ğŸ“‹ No existing version tags found"
          fi

      - name: Compare versions
        id: compare_versions
        run: |
          echo "ğŸ”„ Comparing versions..."
          CURRENT_VERSION="${{ steps.extract_version.outputs.version }}"
          LATEST_VERSION="${{ steps.get_tags.outputs.latest_version }}"
          FORCE_TAG="${{ github.event.inputs.force_tag || 'false' }}"
          
          if [[ "$FORCE_TAG" == "true" ]]; then
            echo "ğŸ”§ Force tag mode enabled"
            echo "should_tag=true" >> $GITHUB_OUTPUT
          else
            # Simple version comparison (assuming semantic versioning)
            if python -c "
            import sys
            from packaging import version
            
            current = '${CURRENT_VERSION}'
            latest = '${LATEST_VERSION}'
            
            if version.parse(current) > version.parse(latest):
                print(f'âœ… Version {current} is newer than {latest}')
                print('should_tag=true')
            else:
                print(f'â„¹ï¸ Version {current} is not newer than {latest}')
                print('should_tag=false')
            " 2>/dev/null; then
              SHOULD_TAG=$(python -c "
              import sys
              from packaging import version
              
              current = '${CURRENT_VERSION}'
              latest = '${LATEST_VERSION}'
              
              if version.parse(current) > version.parse(latest):
                  print('true')
              else:
                  print('false')
              ")
              echo "should_tag=$SHOULD_TAG" >> $GITHUB_OUTPUT
            else
              # Fallback comparison if packaging module not available
              if [[ "$CURRENT_VERSION" != "$LATEST_VERSION" ]]; then
                echo "âœ… Version changed from $LATEST_VERSION to $CURRENT_VERSION"
                echo "should_tag=true" >> $GITHUB_OUTPUT
              else
                echo "â„¹ï¸ Version unchanged: $CURRENT_VERSION"
                echo "should_tag=false" >> $GITHUB_OUTPUT
              fi
            fi
          fi

      - name: Check if tag already exists
        id: check_tag_exists
        run: |
          VERSION="${{ steps.extract_version.outputs.version }}"
          TAG_NAME="v$VERSION"
          
          if git rev-parse --verify "refs/tags/$TAG_NAME" >/dev/null 2>&1; then
            echo "âŒ Tag $TAG_NAME already exists"
            echo "tag_exists=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… Tag $TAG_NAME does not exist yet"
            echo "tag_exists=false" >> $GITHUB_OUTPUT
          fi

  create-and-push-tag:
    needs: detect-version-change
    if: |
      needs.detect-version-change.outputs.should_tag == 'true' && 
      needs.detect-version-change.outputs.tag_exists == 'false' &&
      needs.detect-version-change.outputs.valid == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create and push tag
        run: |
          VERSION="${{ needs.detect-version-change.outputs.version }}"
          TAG_NAME="v$VERSION"
          DRY_RUN="${{ github.event.inputs.dry_run || 'false' }}"
          
          echo "ğŸ·ï¸ Creating tag: $TAG_NAME"
          echo "ğŸ“ Version: $VERSION"
          echo "ğŸ”§ Dry run: $DRY_RUN"
          
          if [[ "$DRY_RUN" == "true" ]]; then
            echo "ğŸ§ª DRY RUN: Would create tag $TAG_NAME"
            echo "ğŸ§ª DRY RUN: Would push tag to trigger publish.yml workflow"
          else
            # Create the tag
            git tag -a "$TAG_NAME" -m "Release $TAG_NAME
            
            # Push the tag to trigger the publish workflow
            git push origin "$TAG_NAME"
            
            echo "âœ… Tag $TAG_NAME created and pushed successfully"
            echo "ğŸš€ This will trigger the publish.yml workflow"
          fi

  skip-tagging:
    needs: detect-version-change
    if: |
      needs.detect-version-change.outputs.should_tag == 'false' || 
      needs.detect-version-change.outputs.tag_exists == 'true' ||
      needs.detect-version-change.outputs.valid == 'false'
    runs-on: ubuntu-latest
    
    steps:
      - name: Report skip reason
        run: |
          SHOULD_TAG="${{ needs.detect-version-change.outputs.should_tag }}"
          TAG_EXISTS="${{ needs.detect-version-change.outputs.tag_exists }}"
          VALID="${{ needs.detect-version-change.outputs.valid }}"
          VERSION="${{ needs.detect-version-change.outputs.version }}"
          
          echo "ğŸ“‹ Version tagging analysis complete"
          echo "ğŸ“ Version: $VERSION"
          echo "ğŸ·ï¸ Should tag: $SHOULD_TAG"
          echo "ğŸ” Tag exists: $TAG_EXISTS"
          echo "âœ… Valid version: $VALID"
          
          if [[ "$VALID" == "false" ]]; then
            echo "âŒ Skipping: Version does not follow semantic versioning"
          elif [[ "$TAG_EXISTS" == "true" ]]; then
            echo "âŒ Skipping: Tag already exists"
          elif [[ "$SHOULD_TAG" == "false" ]]; then
            echo "â„¹ï¸ Skipping: Version unchanged or not newer"
          fi
          
          echo "ğŸ’¡ To force tag creation, use workflow_dispatch with force_tag=true"